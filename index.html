<html>
<head>
 <title>Grades Report - Student View</title>
 <style>
	table#overall{
		width:100%;
	}
	table#overall td{
		width:100%;position:relative;background-color:rgba(0,0,255,0.5);text-align:center;color:white;text-shadow:0 0 2px black;
	}
	table#overall div{
		position:absolute;
		z-index:-1;
		top:0;
		left:0;
		height:100%;
		width:0%;
		background-color:green;
	}
 </style>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.min.js" integrity="sha256-aYYnqVVhAJ4lDammP4Qybmxg3/HVpA7/sNSCntyCyu4=" crossorigin="anonymous"></script>
 <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pouchdb/5.3.1/pouchdb.min.js"></script>
 <script language="javascript" type="text/javascript" src="https://cdn.rawgit.com/pouchdb/upsert/master/dist/pouchdb.upsert.min.js"></script>
 
 <script>
	JSON.clone = JSON.clone || function(json){
		json = JSON.stringify(json);
		json = JSON.parse(json);
		return json;
	}
	
	app = {
		KeyDelim: '.',
		docsDiffer: function(oldDoc, newDoc){
			oldDoc = JSON.clone(oldDoc);
			newDoc = JSON.clone(newDoc);
			
			for(let field in oldDoc){
				if(field.substr(0,1) === '_'){
					delete oldDoc[field];
				}
			}
			for(let field in newDoc){
				if(field.substr(0,1) === '_'){
					delete newDoc[field];
				}
			}
			
			oldDoc = JSON.stringify(oldDoc);
			newDoc = JSON.stringify(newDoc);
			
			rtn = (oldDoc !== newDoc);
			return rtn;
		}
	};
	
 </script>

 <script src="data.js"></script>
 
 <script>
	var db = new PouchDB('grades',{
		auto_compaction: false, 
		//adapter:'websql',
	});
	db.on('error', function (err) { debugger; });
	//db.destroy();
	var remoteCouch = false;
	
	db.upsert('_design/metrics',function(oldDoc){
		console.debug('Generating database views...');
		var newDoc = {};
		newDoc.views = {
			'grades': {
				map: function(doc) {
					// determine if the object belongs in this listing
					if (!doc) return;
					if (doc.isConfig) return;
					if (doc.isExcused) return;
					
					var key = doc._id.split(app.KeyDelim);
					if(key[0] !== 'grade') return;
					key.shift();
					
					
					emit(key,{
						grade: doc.weighted.grade || 0,
						of: doc.weighted.of,
						pct: doc.weighted.grade / doc.weighted.of,
					});
				}.toString()
				,reduce: function(keys, values, rereduce) {
					grade = 0;
					of = 0;
					count = 0;
					values.forEach(function(rec){
						grade += rec.grade;
						of += rec.of;
						count += rec.count || 1;
					});
					return {
						grade: grade,
						of:    of,
						pct:   grade/of,
						count: count
					};
				}.toString()
			}
		};
		
		if(!app.docsDiffer(oldDoc,newDoc)) {
			console.log('metrics calculations: current');
			return false;
		}
		console.log('metrics calculations: rebuilding (change detected)');
		return newDoc;
				
	}).then(function(){
	
		/**
		* Import my data
		*/
		gradeData.forEach(function(rec){
			let key = ["grade","student_id",rec.cat,rec.item,rec.date].join('.');
			db.upsert(key, function(doc){
				let differ = app.docsDiffer(doc,rec);
				if(differ){
					doc._id = key;
					return rec;
				}
				return false;
			}).then(function(rec){
				//console.log(JSON.stringify(rec));
			}).catch(function(err){
				console.log(JSON.stringify(err));
			});
		});
	}).catch(function(err){
		console.log(err.message);
	});
</script>
</head>
<body>

<select>
 <option value="W0000000">Joel, Billy</option>
 <option value="W0000001">Hutch, Starsky</option>
 <option value="W0000002">Young, Angus</option>
</select>

<h1>Joel, Billy</h1>
<p>W000000</p>
<details>
 <summary>
  <table id="overall">
   <caption></caption>
   <tbody>
    <tr>
     <td><div style="width:50%;"></div>Course Progress (10 of 20 days)</td>
    </tr>
    <tr>
     <td><div style='width:40%;'></div>Grades (40% of Total Grades)</td>
    </tr>
   </tbody>
  </table>
 </summary>
</details>

<details id="studentgrades" open>
 <summary>Grades (97%)</summary>
 <script>
	'use strict';
	(function(){
		let opts = {
			include_docs:true,
			reduce:false,
		};
		db.query('metrics/grades', opts)
			.then( function(result){
		
				// alright... time to start rendering it
				let table = d3.select("#studentgrades").append("table");
				let thead = table.append("thead");
				let tbody = table.append("tbody");
				
				// append the header row
				let head = JSON.clone(['somefield']);
				head.unshift("Total");
				head.unshift("");
				thead.append("tr")
					.selectAll("th")
					.data(head)
					.enter()
						.append("th")
						.text((column)=>{ return column; })
						;
				
				// create a row for each object in the data
				var rows = tbody.selectAll("tr")
					.data(cumulative.data)
					.enter()
					.append("tr")
					;
				
				rows.selectAll("th")
					.data(function(d){
						let pct = Math.floor(100.0 * d.achieved.total / d.possible.total);
						pct = Number.isNaN(pct) ? 0 : pct;
						let rtn = "{{achieved}}% of {{possible}}% ({{pct}}%)"
							.replace(/{{achieved}}/g,Math.floor(d.achieved.total * 100))
							.replace(/{{possible}}/g,Math.floor(d.possible.total * 100))
							.replace(/{{pct}}/g,pct)
							;
						return [
							d.date,
							rtn
						];
					})
					.enter()
						.append("th")
						.text(function(d){
							return d;
						})
					;
				
				var cells = rows.selectAll('td')
					.data(function (row) {
						return row.achieved.values.map(function (achieved,i) {
							let rtn = {
								achieved: achieved,
								possible: row.possible.values[i],
							};
							return rtn;
						});
					})
					.enter()
						.append('td')
						.text(function (d) {
						let pct = Math.floor(100.0 * d.achieved.total / d.possible.total);
						pct = Number.isNaN(pct) ? 0 : pct;
							let rtn = "{{achieved}} of {{possible}} ({{pct}})"
								.replace(/{{achieved}}/g,Math.floor(d.achieved * 100))
								.replace(/{{possible}}/g,Math.floor(d.possible * 100))
								.replace(/{{pct}}/g, pct)
							return rtn;
						})
						;
			})
			.catch(function(err){
				console.log(err);
			});
	})();	
 </script>
 <style>
	details#studentgrades table{
		border:1px solid black;
		border-collapse: collapse;
		font-family:monospace;
		font-size:0.75em;
		
	}
	details#studentgrades td,th{
		border:1px solid black;
		padding: 0.5em;
	}
	/*
	details#studentgrades th{
		background-color:black;
		color:white;
	}
	*/
 </style>
</details>

<details>
 <summary>Attendance</summary>
 <table>
  <tr>
   <td></td>
  </tr>
 </table>
</details>


</body>
</html>
