<html>
<head>
 <title>Grades Report - Student View</title>
 <style>
	table#overall{
		width:100%;
	}
	table#overall td{
		width:100%;position:relative;background-color:rgba(0,0,255,0.5);text-align:center;color:white;text-shadow:0 0 2px black;
	}
	table#overall div{
		position:absolute;
		z-index:-1;
		top:0;
		left:0;
		height:100%;
		width:0%;
		background-color:green;
	}
 </style>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.min.js" integrity="sha256-aYYnqVVhAJ4lDammP4Qybmxg3/HVpA7/sNSCntyCyu4=" crossorigin="anonymous"></script>
 <script>
	var gradeData = [
		{
			"date":"2017-10-12",
			"cat":"Tech Checks",
			"item":"TechCheck 1",
			"grade":{
				"grade":8,
				"of":10
			},
			"weight":{
				"grade":null,
				"of":0.08,
			}
		},
		{
			"date":"2017-10-18",
			"cat":"Tech Checks",
			"item":"TechCheck 2",
			"grade":{
				"grade":null,
				"of":10
			},
			"weight":{
				"grade":null,
				"of":0.08,
			}
		},
	]
	gradeData = gradeData.map(d=>{
		if(d.grade.grade){
			d.pct = d.grade.grade / d.grade.of;
			d.weight.grade = d.pct * d.weight.of;
		}
		return d;
	});
 </script>
 <script>
	JSON.clone = JSON.clone || function(json){
		json = JSON.stringify(json);
		json = JSON.parse(json);
		return json;
	}
 </script>
</head>
<body>

<select>
 <option value="W0000000">Joel, Billy</option>
 <option value="W0000001">Hutch, Starsky</option>
 <option value="W0000002">Young, Angus</option>
</select>

<h1>Joel, Billy</h1>
<p>W000000</p>
<details>
 <summary>
  <table id="overall">
   <caption></caption>
   <tbody>
    <tr>
     <td><div style="width:50%;"></div>Course Progress (10 of 20 days)</td>
    </tr>
    <tr>
     <td><div style='width:40%;'></div>Grades (40% of Total Grades)</td>
    </tr>
   </tbody>
  </table>
 </summary>
</details>

<details id="studentgrades" open>
 <summary>Grades (97%)</summary>
 <script>
	'use strict';
	
	var cumulative = {
		headers : [],
		data:[{
			date:"1900-01-01",
			achieved:{values:[],total:0},
			possible:{values:[],total:0},
			estimate:{values:[],total:0},
		}],
	};
	cumulative = gradeData
		.sort(function(a,b){
			if(a.date>b.date) return 1; 
			if(a.date<b.date) return -1; 
			return 0;
		})
		.reduce(function(a,d){
			// copy the values from the last one
			let rec = JSON.clone(a.data[0]);
			a.data.unshift(rec);
			// if the category is a new one, we need to add it to 
			// every value field we have already seen go by, as 
			// well as keep track of it in the headers array
			if(!a.headers.includes(d.cat)){
				a.headers.push(d.cat);
				a.data.forEach((d)=>{
					d.achieved.values.push(0);
					d.possible.values.push(0);
					d.estimate.values.push(0);
				});
			}
			
			let catIndex = a.headers.indexOf(d.cat);
			
			rec.date = d.date;
			
			rec.achieved.values[catIndex] += d.weight.grade;
			rec.possible.values[catIndex] += d.weight.of;
			rec.achieved.total += d.weight.grade;
			rec.possible.total += d.weight.of;
			
			return a;
		},cumulative)
		;
	// pop the initial value of the top of the stack
	// we only put it there for initialization purposes
	// then flip the array, because we built it backwards
	cumulative.final = cumulative.data[0];
	cumulative.data.pop();
	cumulative.data.reverse();
	
	// alright... time to start rendering it
	var table = d3.select("#studentgrades").append("table");
	var thead = table.append("thead");
	var tbody = table.append("tbody");
	
	// append the header row
	thead.append("tr")
		.selectAll("th")
		.data(cumulative.headers)
		.enter()
			.append("th")
			.text((column)=>{ return column; })
			;
	
	// create a row for each object in the data
	var rows = tbody.selectAll("tr")
		.data(cumulative.data)
		.enter()
		.append("tr")
		;
	
	rows.selectAll("th")
		.data(function(d){
			let rtn = "{{achieved}}% of {{possible}}% ({{pct}}%)"
				.replace(/{{achieved}}/g,Math.floor(d.achieved.total * 100))
				.replace(/{{possible}}/g,Math.floor(d.possible.total * 100))
				.replace(/{{pct}}/g,Math.floor(100.0 * d.achieved.total / d.possible.total))
				;
			return [
				d.date,
				rtn
			];
		})
		.enter()
			.append("th")
			.text(function(d){
				return d;
			})
		;
	
	var cells = rows.selectAll('td')
		.data(function (row) {
			return row.achieved.values.map(function (achieved,i) {
				let rtn = {
					achieved: achieved,
					possible: row.possible.values[i],
				};
				return rtn;
		    });
		})
		.enter()
			.append('td')
			.text(function (d) {
				let rtn = "{{achieved}}% of {{possible}}% ({{pct}}%)"
					.replace(/{{achieved}}/g,Math.floor(d.achieved * 100))
					.replace(/{{possible}}/g,Math.floor(d.possible * 100))
					.replace(/{{pct}}/g,Math.floor(100.0 * d.achieved / d.possible))
				return rtn;
			})
			;
	
 </script>
</details>

<details>
 <summary>Attendance</summary>
 <table>
  <tr>
   <td></td>
  </tr>
 </table>
</details>


</body>
</html>
